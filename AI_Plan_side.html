<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study Planner App</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Lucide Icons UMD -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
</head>

<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function StudyPlannerApp() {
      // ==========================
      // 1) 상태 정의
      // ==========================
      const [currentView, setCurrentView] = useState('schedule'); // 'schedule' 또는 'ai'
      const [userPlans, setUserPlans] = useState([
        { id: 1, title: '영어 단어 암기', memo: '새 단어 20개', start: '16:00', end: '17:30', emoji: '📚' },
        { id: 2, title: '수학 문제 풀이', memo: '기출문제 5개', start: '18:00', end: '19:00', emoji: '📐' }
      ]);
      const [aiPlans, setAiPlans] = useState([]);
      const [draggedItem, setDraggedItem] = useState(null);

      // 리사이즈 관련 상태 (planId, type: 'top'|'bottom', 초기 슬롯 인덱스, 초기 마우스 Y좌표)
      const [resizing, setResizing] = useState(null);

      // 모달 관련 상태
      const [showModal, setShowModal] = useState(false);
      const [editingPlan, setEditingPlan] = useState(null);
      const [newPlan, setNewPlan] = useState({
        title: '',
        memo: '',
        start: '21:00',
        end: '22:00',
        emoji: '📚'
      });

      const resizeDataRef = useRef(null);
      // ==========================
      // 2) Lucide 아이콘 렌더링
      // ==========================
      useEffect(() => {
        lucide.createIcons();
      }, []);

      // ==========================
      // 3) 시간 슬롯 계산 (08:00 ~ 20:00)
      // ==========================
      const slotHeight = 60; // 30분 슬롯당 높이(px)
      const startHour = 8, endHour = 20;
      const totalSlots = (endHour - startHour) * 2; // 12시간 * 2 = 24 슬롯

      // 예: ['08:00','08:30','09:00',...,'19:30']
      const timeSlots = Array.from({ length: totalSlots }, (_, i) => {
        const totalMinutes = startHour * 60 + i * 30;
        const hh = String(Math.floor(totalMinutes / 60)).padStart(2, '0');
        const mm = String(totalMinutes % 60).padStart(2, '0');
        return `${hh}:${mm}`;
      });

      // ==========================
      // 4) 드래그앤드롭 핸들러
      // ==========================
      const handleDragStart = (e, plan) => {
        setDraggedItem(plan);
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragOver = e => {
        e.preventDefault();
      };

      const handleDrop = (e, targetTime) => {
        e.preventDefault();
        if (!draggedItem) return;

        // draggedItem의 기존 duration(분)
        const [sh, sm] = draggedItem.start.split(':').map(Number);
        const [eh, em] = draggedItem.end.split(':').map(Number);
        const durationMins = (eh * 60 + em) - (sh * 60 + sm);

        // targetTime → 슬롯 인덱스
        const [th, tm] = targetTime.split(':').map(Number);
        const targetTotal = th * 60 + tm;
        const relativeMins = targetTotal - (startHour * 60);
        const targetIdx = relativeMins / 30;

        // 새 종료 시간 계산
        const newEndTotal = targetTotal + durationMins;
        const newEndH = Math.floor(newEndTotal / 60);
        const newEndM = newEndTotal % 60;
        const newEndStr = `${String(newEndH).padStart(2, '0')}:${String(newEndM).padStart(2, '0')}`;

        const updated = {
          ...draggedItem,
          start: targetTime,
          end: newEndStr
        };

        setUserPlans(plans =>
          plans.map(x => (x.id === updated.id ? updated : x))
        );
        setDraggedItem(null);
      };

      // ==========================
      // 5) 플랜 삭제
      // ==========================
      const deletePlan = id => {
        setUserPlans(plans => plans.filter(x => x.id !== id));
      };

      // ==========================
      // 6) 편집 모달 열기
      // ==========================
      const onEdit = plan => {
        setEditingPlan(plan);
        setNewPlan({
          title: plan.title,
          memo: plan.memo,
          start: plan.start,
          end: plan.end,
          emoji: plan.emoji
        });
        setShowModal(true);
      };

      // ==========================
      // 7) AI 제안 생성
      // ==========================
      const generateAiSuggestions = () => {
        const suggestions = [
          { title: '물리 공식 정리', emoji: '⚛️' },
          { title: '역사 연표 암기', emoji: '📜' },
          { title: '생물 세포 구조', emoji: '🔬' },
          { title: '문학 작품 분석', emoji: '📖' },
          { title: '화학 반응식', emoji: '🧪' }
        ];
        const pick = suggestions.sort(() => 0.5 - Math.random()).slice(0, 3);
        const newAi = pick.map((it, i) => ({
          id: Date.now() + i,
          title: it.title,
          memo: '',
          start: `${19 + i}:00`,
          end: `${20 + i}:00`,
          emoji: it.emoji
        }));
        setAiPlans(newAi);
      };

      const applyAiPlans = () => {
        const cloned = aiPlans.map(pl => ({ ...pl, id: Date.now() + Math.random() }));
        setUserPlans(plans => [...plans, ...cloned]);
        setAiPlans([]);
        setCurrentView('schedule');
      };

      // ==========================
      // 8) 새/수정 저장
      // ==========================
      const savePlan = () => {
        if (!newPlan.title || !newPlan.start || !newPlan.end) return;
        if (editingPlan) {
          // 수정
          setUserPlans(plans =>
            plans.map(x =>
              x.id === editingPlan.id ? { ...editingPlan, ...newPlan } : x
            )
          );
        } else {
          // 새로 추가
          setUserPlans(plans => [...plans, { ...newPlan, id: Date.now() }]);
        }
        setEditingPlan(null);
        setNewPlan({ title: '', memo: '', start: '21:00', end: '22:00', emoji: '📚' });
        setShowModal(false);
      };

      // ==========================
      // 9) 카드 리사이즈 로직
      // ==========================
      // 사용자가 카드 상단이나 하단 가장자리를 잡고 드래그하면 호출되는 함수
      const startResizing = (e, planId, edge) => {
        // edge: 'top' 또는 'bottom'
        e.stopPropagation();
        e.preventDefault();

        // 마우스 Y 좌표와 해당 플랜의 초기 슬롯 인덱스, 초기 마우스 Y를 저장
        const plan = userPlans.find(p => p.id === planId);
        if (!plan) return;

        // 현재 plan의 시작/종료 슬롯 인덱스 계산
        const [sh, sm] = plan.start.split(':').map(Number);
        const startIdx = ((sh * 60 + sm) - (startHour * 60)) / 30;

        const [eh, em] = plan.end.split(':').map(Number);
        const endIdx = ((eh * 60 + em) - (startHour * 60)) / 30;

        // 마우스 현재 Y 위치 (브라우저 뷰포트 기준)
        const initialMouseY = e.clientY;

        resizeDataRef.current = {
          planId,
          edge,            // 'top' or 'bottom'
          initialMouseY,   // 리사이즈 시작 시점의 Y
          initialStartIdx: startIdx,
          initialEndIdx: endIdx
        };
        setResizing(resizeDataRef.current);
      };

      // 마우스 이동 시 리사이즈 중이면 호출되는 함수
      const onMouseMove = e => {
        if (!resizeDataRef.current) return;
        const { planId, edge, initialMouseY, initialStartIdx, initialEndIdx } = resizeDataRef.current;
        const deltaY = e.clientY - initialMouseY; // 마우스 이동량(px)
        const deltaSlots = Math.round(deltaY / slotHeight); // 몇 슬롯 만큼 움직였는지

        // 원본 플랜
        const plan = userPlans.find(p => p.id === planId);
        if (!plan) return;

        let newStartIdx = initialStartIdx;
        let newEndIdx = initialEndIdx;

        if (edge === 'top') {
          newStartIdx = initialStartIdx + deltaSlots;
          // 최소값: 0, 최대값: initialEndIdx - 1(시작이 종료보다 같거나 커지면 안 됨)
          if (newStartIdx < 0) newStartIdx = 0;
          if (newStartIdx >= initialEndIdx) newStartIdx = initialEndIdx - 1;
        } else if (edge === 'bottom') {
          newEndIdx = initialEndIdx + deltaSlots;
          // 최소값: initialStartIdx + 1, 최대값: totalSlots
          if (newEndIdx <= initialStartIdx) newEndIdx = initialStartIdx + 1;
          if (newEndIdx > totalSlots) newEndIdx = totalSlots;
        }

        // newStartIdx 또는 newEndIdx가 변경되었으면 새 시간 문자열 계산
        let updatedStart = plan.start;
        let updatedEnd = plan.end;

        if (edge === 'top' && newStartIdx !== initialStartIdx) {
          const newStartTotalMins = startHour * 60 + newStartIdx * 30;
          const nsH = Math.floor(newStartTotalMins / 60);
          const nsM = newStartTotalMins % 60;
          updatedStart = `${String(nsH).padStart(2, '0')}:${String(nsM).padStart(2, '0')}`;
        }
        if (edge === 'bottom' && newEndIdx !== initialEndIdx) {
          const newEndTotalMins = startHour * 60 + newEndIdx * 30;
          const neH = Math.floor(newEndTotalMins / 60);
          const neM = newEndTotalMins % 60;
          updatedEnd = `${String(neH).padStart(2, '0')}:${String(neM).padStart(2, '0')}`;
        }

        // 상태가 바뀔 때마다 업데이트
        setUserPlans(plans =>
          plans.map(x =>
            x.id === planId ? { ...x, start: updatedStart, end: updatedEnd } : x
          )
        );
      };

      // 마우스 업 시 리사이즈 종료
      const onMouseUp = () => {
        resizeDataRef.current = null;
        setResizing(null);
      };

      // 마운트 시 전역 mousemove, mouseup 이벤트 등록 → 리사이즈가 필요할 때만 동작
      useEffect(() => {
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
        return () => {
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
        };
      }, []);

      // ==========================
      // 10) 렌더링
      // ==========================
      return (
        <div className="max-w-md mx-auto bg-white min-h-screen relative overflow-hidden">
          {/* ======================= */}
          {/*        헤더 부분       */}
          {/* ======================= */}
          <header className="bg-orange-50 p-3 border-b border-orange-100 sticky top-0 z-10 flex justify-between items-center">
            <h1 className="text-xl font-bold text-gray-800">My Plan</h1>
            <div className="flex gap-2">
              <button
                onClick={() => window.location.reload()}
                className="p-2 text-orange-600 hover:bg-orange-100 rounded-lg"
                aria-label="새로고침"
              >
                <i data-lucide="refresh-cw" className="lucide" style={{ width: 20, height: 20 }} />
              </button>
              <button
                onClick={() => alert('설정')}
                className="p-2 text-orange-600 hover:bg-orange-100 rounded-lg"
                aria-label="설정"
              >
                <i data-lucide="settings" className="lucide" style={{ width: 20, height: 20 }} />
              </button>
            </div>
          </header>

          {/* ======================= */}
          {/*      메인 콘텐츠       */}
          {/* ======================= */}
          <div className="flex h-full">

            {/* ======================= */}
            {/*    1) 스케줄 뷰 화면    */}
            {/* ======================= */}
            <div
              className={`w-full relative transition-transform duration-300 ${currentView === 'ai' ? '-translate-x-full' : 'translate-x-0'
                }`}
            >
              {/* ◼︎ 시간 슬롯 그리드 (배경) */}
              <div className="h-full overflow-y-auto bg-orange-50 pb-28">
                {timeSlots.map((time) => {
                  const isHour = time.endsWith(':00');
                  return (
                    <div
                      key={time}
                      className="flex items-start border-b border-gray-200"
                      style={{
                        height: `${slotHeight}px`,
                        backgroundColor: isHour ? '#ffffff' : '#f8fafd'
                      }}
                      onDragOver={handleDragOver}
                      onDrop={(e) => handleDrop(e, time)}
                    >
                      <div className="w-16 text-center text-gray-600 font-medium pt-2">
                        {isHour ? time : ''}
                      </div>
                      <div className="flex-1 pl-4"></div>
                    </div>
                  );
                })}
              </div>

              {/* ◼︎ 절대 위치: 일정 카드 오버레이 */}
              {userPlans.map(plan => {
                // 1) 시작/종료 슬롯 인덱스 계산
                const [sh, sm] = plan.start.split(':').map(Number);
                const startTotal = (sh * 60 + sm) - (startHour * 60);
                const startIdx = startTotal / 30;

                const [eh, em] = plan.end.split(':').map(Number);
                const endTotal = (eh * 60 + em) - (startHour * 60);
                const endIdx = endTotal / 30;

                // 2) span 및 top/height 계산
                const spanSlots = endIdx - startIdx;
                const topPx = startIdx * slotHeight;
                const heightPx = spanSlots * slotHeight;

                return (
                  <div
                    key={plan.id}
                    draggable
                    onDragStart={e => handleDragStart(e, plan)}
                    className="absolute left-16 right-4 bg-white border-2 border-orange-500 rounded-xl shadow-md cursor-move hover:shadow-lg overflow-hidden"
                    style={{
                      top: `${topPx}px`,
                      height: `${heightPx}px`
                    }}
                  >
                    {/* ◼︎ 상단 리사이저 (투명 바) */}
                    <div
                      className="absolute left-0 right-0 h-2 cursor-ns-resize z-20"
                      style={{ top: '-1px' }}
                      onMouseDown={e => {
                        e.stopPropagation();
                        startResizing(e, plan.id, 'top');
                      }}
                    />

                    {/* ◼︎ 편집/삭제 아이콘 버튼 */}
                    <div className="absolute top-1 right-1 flex space-x-1 z-10">
                      <button
                        onClick={() => onEdit(plan)}
                        className="p-1 rounded hover:bg-gray-200 z-10"
                      >
                        <i data-lucide="edit-3" className="lucide" style={{ width: 14, height: 14 }} />
                      </button>
                      <button
                        onClick={() => deletePlan(plan.id)}
                        className="p-1 rounded hover:bg-gray-200 z-10"
                      >
                        <i data-lucide="trash-2" className="lucide" style={{ width: 14, height: 14 }} />
                      </button>
                    </div>

                    {/* ◼︎ 카드 내부 콘텐츠 */}
                    <div className="flex items-center gap-2 p-2 pt-6">
                      <span className="text-2xl">{plan.emoji}</span>
                      <div>
                        <div className="font-medium text-sm">{plan.title}</div>
                        <div className="text-xs text-gray-500">
                          {plan.start} ~ {plan.end}
                        </div>
                        {plan.memo && <div className="text-xs text-gray-600">메모: {plan.memo}</div>}
                      </div>
                    </div>

                    {/* ◼︎ 하단 리사이저 (투명 바) */}
                    <div
                      className="absolute left-0 right-0 h-2 cursor-ns-resize z-20"
                      style={{ bottom: '1px' }}
                      onMouseDown={e => {
                        e.stopPropagation();
                        startResizing(e, plan.id, 'bottom');
                      }}
                    />
                  </div>
                );
              })}
            </div>

            {/* ======================= */}
            {/*      2) AI 뷰 화면     */}
            {/* ======================= */}
            <div
              className={`w-full absolute top-0 transition-transform duration-300 ${currentView === 'ai' ? 'translate-x-0' : 'translate-x-full'
                }`}
            >
              <div className="p-4 h-screen overflow-y-auto pb-28 bg-orange-100">
                {/* 뒤로 가기 버튼 및 타이틀 */}
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold flex items-center gap-2">
                    <span>🤖</span> AI 추천 플랜
                  </h2>
                  <button
                    onClick={() => setCurrentView('schedule')}
                    className="text-orange-600"
                  >
                    ← 돌아가기
                  </button>
                </div>

                {/* AI 제안 플랜 카드 목록 */}
                <div className="space-y-3">
                  {aiPlans.map(pl => (
                    <div
                      key={pl.id}
                      className="p-4 bg-orange-500 text-white rounded-xl shadow-sm"
                    >
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">{pl.emoji}</span>
                        <div>
                          <div className="font-medium">{pl.title}</div>
                          <div className="text-sm text-orange-100">
                            {pl.start} ~ {pl.end}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* AI 생성 버튼 */}
                {aiPlans.length === 0 && (
                  <div className="text-center py-8">
                    <button
                      onClick={generateAiSuggestions}
                      className="bg-orange-500 text-white px-6 py-3 rounded-full"
                    >
                      AI 플랜 생성하기
                    </button>
                  </div>
                )}

                {/* AI 적용 버튼 */}
                {aiPlans.length > 0 && (
                  <div className="text-center mt-6">
                    <button
                      onClick={applyAiPlans}
                      className="bg-orange-500 text-white px-6 py-3 rounded-full"
                    >
                      내 플래너에 적용
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* ======================= */}
          {/*    3) 하단 명령 바     */}
          {/* ======================= */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4">
            <div className="max-w-md mx-auto flex gap-3">
              {currentView === 'schedule' ? (
                <button
                  onClick={() => setCurrentView('ai')}
                  className="flex-1 bg-white border-2 border-orange-500 text-orange-500 py-3 rounded-full"
                >
                  AI에 명령
                </button>
              ) : (
                <div className="flex-1 flex items-center bg-white border-2 border-orange-500 rounded-full px-3 py-2">
                  <input
                    type="text"
                    placeholder="AI에게 플랜을 요청해보세요"
                    className="flex-1 outline-none bg-transparent text-orange-500 placeholder-orange-300"
                    onKeyDown={e => {
                      if (e.key === 'Enter') generateAiSuggestions();
                    }}
                  />
                  <span className="ml-2 text-2xl">🤖</span>
                </div>
              )}

              {currentView === 'ai' && aiPlans.length > 0 && (
                <button
                  onClick={applyAiPlans}
                  className="flex-1 bg-orange-500 text-white py-3 rounded-full"
                >
                  적용
                </button>
              )}
            </div>
          </div>

          {/* ======================= */}
          {/* 4) 플랜 추가/수정 모달  */}
          {/* ======================= */}
          {showModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold text-center mb-4">
                  {editingPlan ? '일정 수정' : '새 일정 추가'}
                </h3>
                <div className="space-y-4">
                  <div>
                    <label className="block mb-1">할 일</label>
                    <input
                      type="text"
                      value={newPlan.title}
                      onChange={e => setNewPlan(p => ({ ...p, title: e.target.value }))}
                      className="w-full border p-2 rounded"
                    />
                  </div>
                  <div>
                    <label className="block mb-1">메모</label>
                    <input
                      type="text"
                      value={newPlan.memo}
                      onChange={e => setNewPlan(p => ({ ...p, memo: e.target.value }))}
                      className="w-full border p-2 rounded"
                    />
                  </div>
                  <div>
                    <label className="block mb-1">시간</label>
                    <div className="flex items-center gap-2">
                      <input
                        type="time"
                        value={newPlan.start}
                        onChange={e => setNewPlan(p => ({ ...p, start: e.target.value }))}
                        className="border p-2 rounded w-1/2"
                      />
                      <span>~</span>
                      <input
                        type="time"
                        value={newPlan.end}
                        onChange={e => setNewPlan(p => ({ ...p, end: e.target.value }))}
                        className="border p-2 rounded w-1/2"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block mb-1">이모지</label>
                    <div className="flex gap-2">
                      {['📚', '✏️', '📐', '🧪', '💡'].map(em => (
                        <button
                          key={em}
                          onClick={() => setNewPlan(p => ({ ...p, emoji: em }))}
                          className={`p-2 text-2xl rounded ${newPlan.emoji === em ? 'bg-orange-100' : ''
                            }`}
                        >
                          {em}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
                <div className="mt-6 flex gap-3">
                  <button
                    onClick={() => {
                      setShowModal(false);
                      setEditingPlan(null);
                    }}
                    className="flex-1 border py-3 rounded"
                  >
                    취소
                  </button>
                  <button
                    onClick={savePlan}
                    className="flex-1 bg-orange-500 text-white py-3 rounded"
                  >
                    {editingPlan ? '수정 완료' : '추가'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ======================= */}
          {/* 5) 새 일정 추가 버튼   */}
          {/* ======================= */}
          <button
            onClick={() => {
              setEditingPlan(null);
              setShowModal(true);
            }}
            className="fixed bottom-24 right-4 bg-orange-500 text-white w-14 h-14 rounded-full flex items-center justify-center"
          >
            <i data-lucide="plus" className="lucide" style={{ width: 24, height: 24 }} />
          </button>
        </div>
      );
    }

    ReactDOM.render(<StudyPlannerApp />, document.getElementById('root'));
  </script>
</body>

</html>